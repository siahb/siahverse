<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📝 Siah To Do</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="todo.css">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
</head>
<body>
  <canvas id="stars"></canvas>

  <!-- Theme Toggle -->
  <div id="toggle-theme" class="theme-switch">
    <label class="theme-switch">
      <input type="checkbox" id="toggle-theme-checkbox">
      <span class="slider"></span>
    </label>
  </div>

  <div class="container">
    <div class="top-bar">
      <div class="button-group">
        <button id="enter-password">🔐 Enter Password</button>
        <button id="logout">🚪 Logout</button>
      </div>
      <h1><span>✅</span> Siah To Do</h1>
    </div>
  </div>

  <div class="main-content">
    <!-- To Do List -->
    <div id="todo-container" class="card-container">
      <h2>To Do List</h2>
      <input type="text" id="todo-input" placeholder="Type a task and hit Enter..." />
      <div class="controls">
        <label><input type="checkbox" id="select-all"> Select All</label>
        <button onclick="deleteSelected()">🗑️ Delete Selected</button>
        <button id="undo-btn">↩️ Undo</button>
        <button id="toggle-drag">🧲 Toggle Drag Mode</button>
      </div>
      <ul id="todo-list"></ul>
    </div>

    <!-- Done List -->
    <div id="done-container" class="card-container">
      <h2>Marked as Done ✅</h2>
      <ul id="done-list"></ul>
    </div>
  </div>

  <!-- Admin Modal -->
  <div id="admin-modal" class="modal">
    <div class="modal-content">
      <h2>Admin Login</h2>
      <input type="password" id="password-input" placeholder="Password" />
      <div class="modal-buttons">
        <button id="login-btn">Login</button>
        <button id="cancel-btn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- ✅ Back Button -->
  <div class="back-button-wrapper">
    <a href="https://siahverse.cc/" class="back-button">Back to Portal</a>
  </div>

<script>
  const todoInput = document.getElementById('todo-input');
  const todoList = document.getElementById('todo-list');
  const doneList = document.getElementById('done-list');
  const undoBtn = document.getElementById('undo-btn');
  const selectAll = document.getElementById('select-all');
  const themeCheckbox = document.getElementById('toggle-theme-checkbox');

  const enterPwBtn = document.getElementById('enter-password');
  const logoutBtn = document.getElementById('logout');
  const adminModal = document.getElementById('admin-modal');
  const loginBtn = document.getElementById('login-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const passwordInput = document.getElementById('password-input');

  let todosData = [];
  let deletedTodos = [];
  const ADMIN_PASSWORD_KEY = 'adminPassword';

  // Button visibility
function updateAdminUI() {
  const pw = localStorage.getItem(ADMIN_PASSWORD_KEY);
  const isLoggedIn = !!pw;

  document.getElementById('enter-password').style.display = isLoggedIn ? 'none' : 'inline-block';
  document.getElementById('logout').style.display = isLoggedIn ? 'inline-block' : 'none';
}

  // Theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    document.body.classList.add('light-mode');
    themeCheckbox.checked = true;
  }
  themeCheckbox.addEventListener('change', () => {
    document.body.classList.toggle('light-mode');
    localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
  });

  // Admin
  enterPwBtn.addEventListener('click', () => adminModal.style.display = 'block');
  cancelBtn.addEventListener('click', () => adminModal.style.display = 'none');
  loginBtn.addEventListener('click', async () => {
  const pw = passwordInput.value.trim();
  if (!pw) return alert("Password cannot be empty.");

  // Send a harmless request to test the password
  const res = await fetch('/todos/0', {
    method: 'DELETE',
    headers: {
      Authorization: `Bearer ${pw}`
    }
  });

  if (res.status === 401) {
    alert("❌ Incorrect password.");
  } else {
    localStorage.setItem(ADMIN_PASSWORD_KEY, pw);
    alert("✅ Admin logged in!");
    todoInput.disabled = false;
    adminModal.style.display = 'none';
    updateAdminUI();
  }
});

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem(ADMIN_PASSWORD_KEY);
    alert("Logged out.");
    todoInput.disabled = true;
    updateAdminUI();
  });
  if (!localStorage.getItem(ADMIN_PASSWORD_KEY)) todoInput.disabled = true;

  // Load Todos from server
  async function loadTodosFromServer() {
    try {
      const res = await fetch('/todos');
      todosData = await res.json();
      renderTodos();
      renderDone();
    } catch {
      alert("Failed to load todos.");
    }
  }

// Render Todos
const renderTodos = () => {
  todoList.innerHTML = '';
  todosData.forEach((todo, i) => {
    if (todo.done) return;

    const li = document.createElement('li');
    li.setAttribute('data-index', i);
    li.innerHTML = `
      <input type="checkbox" class="select-todo" data-index="${i}" />
      <span class="todo-text">${todo.text}</span>
      <div>
        <button onclick="markAsDone(${i})">✅</button>
        <button onclick="editTodo(${i})">✏️</button>
        <button onclick="removeTodo(${i})">❌</button>
      </div>`;
    todoList.appendChild(li);
  });
};
  
// Render Done
 const renderDone = () => {
  doneList.innerHTML = '';
  todosData.forEach((todo, i) => {
    if (!todo.done) return;

    const li = document.createElement('li');
    li.classList.add('done');
    li.innerHTML = `
      <span>${todo.text}</span>
      <div>
        <button onclick="unmarkDone(${i})">↩️</button>
        <button onclick="removeTodo(${i})">❌</button>
      </div>`;
    doneList.appendChild(li);
  });
};
  
  //Editor
  window.editTodo = function(index) {
  const li = todoList.querySelector(`li[data-index="${index}"]`);
  const textSpan = li.querySelector('.todo-text');
  const originalText = textSpan.textContent;

  const input = document.createElement('input');
  input.type = 'text';
  input.value = originalText;
  input.classList.add('edit-input');
  input.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter') {
      await saveEditedTodo(index, input.value);
    }
    if (e.key === 'Escape') {
      cancelEdit(input, originalText);
    }
  });

  textSpan.replaceWith(input);
  input.focus();
};

function cancelEdit(input, originalText) {
  const span = document.createElement('span');
  span.textContent = originalText;
  span.classList.add('todo-text');
  input.replaceWith(span);
}

async function saveEditedTodo(index, newText) {
  try {
    await fetch(`/todos/${index}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ text: newText })
    });
    await loadTodosFromServer();
  } catch {
    alert("Failed to update todo.");
  }
}


  // Add new todo
  todoInput.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter' && todoInput.value.trim()) {
      if (!localStorage.getItem(ADMIN_PASSWORD_KEY)) return alert("Admin only");
      try {
        await fetch('/todos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: todoInput.value.trim() })
        });
        todoInput.value = '';
        await loadTodosFromServer();
      } catch {
        alert("Failed to add todo.");
      }
    }
  });

  // Mark as done
 window.markAsDone = async (index) => {
  try {
    await fetch(`/todos/${index}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ done: true })
    });
    await loadTodosFromServer();
  } catch {
    alert("Failed to mark as done.");
  }
};

  //Unmark done
window.unmarkDone = async (index) => {
  try {
    await fetch(`/todos/${index}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ done: false })
    });
    await loadTodosFromServer();
  } catch {
    alert("Failed to move back to To Do.");
  }
};

  // Remove todo
  window.removeTodo = async (i) => {
    if (!localStorage.getItem(ADMIN_PASSWORD_KEY)) return alert("Admin only");
    deletedTodos.push(todosData[i].text);
    try {
      await fetch(`/todos/${i}`, {
        method: 'DELETE',
        headers: {
          Authorization: `Bearer ${localStorage.getItem(ADMIN_PASSWORD_KEY)}`
        }
      });
      await loadTodosFromServer();
    } catch {
      alert("Failed to delete.");
    }
  };

  // Undo button
  undoBtn.addEventListener('click', async () => {
    for (const text of deletedTodos) {
      await fetch('/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
    }
    deletedTodos = [];
    loadTodosFromServer();
  });

  // Select all checkbox
  selectAll.addEventListener('change', (e) => {
    document.querySelectorAll('.select-todo').forEach(cb => cb.checked = e.target.checked);
  });

  window.deleteSelected = () => {
    if (!localStorage.getItem(ADMIN_PASSWORD_KEY)) return alert("Admin only");
    const selected = [...document.querySelectorAll('.select-todo:checked')].map(cb => parseInt(cb.dataset.index));
    selected.sort((a,b) => b-a);
    selected.forEach(i => {
      window.removeTodo(i);
    });
  };

  //Toggle Drag mode
let dragEnabled = false;
let sortableInstance = null;

const toggleDragBtn = document.getElementById('toggle-drag');

toggleDragBtn.addEventListener('click', () => {
  dragEnabled = !dragEnabled;

  if (dragEnabled) {
    toggleDragBtn.textContent = '🧲 Drag Mode: ON';
    enableDrag();
  } else {
    toggleDragBtn.textContent = '🧲 Drag Mode: OFF';
    disableDrag();
  }
});

function enableDrag() {
  sortableInstance = new Sortable(todoList, {
    animation: 150,
    onEnd: () => {
      const newOrder = [];
      document.querySelectorAll('#todo-list li').forEach(li => {
        const index = li.getAttribute('data-index');
        newOrder.push(todosData[index]);
      });
      todosData = newOrder;
      renderTodos();
    }
  });
}

function disableDrag() {
  if (sortableInstance) {
    sortableInstance.destroy();
    sortableInstance = null;
  }
}
  // Init
  toggleDragBtn.textContent = '🧲 Drag Mode: OFF';
  loadTodosFromServer();

  // Stars
  const canvas = document.getElementById("stars");
  const ctx = canvas.getContext("2d");
  let w,h;
  function resizeCanvas(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    w = canvas.width;
    h = canvas.height;
  }
  resizeCanvas();
  let stars = Array.from({length: 300},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.5+0.5,d:Math.random()*0.5+0.2}));
  function draw(){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star-color').trim()||"#fff";
    stars.forEach(s=>{
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fill();
    });
    move();
  }
  function move(){
    stars.forEach(s=>{
      s.y -= s.d;
      if(s.y<0){s.y=h;s.x=Math.random()*w;}
    });
  }
  function animate(){
    draw();
    requestAnimationFrame(animate);
  }
  animate();
  window.addEventListener('resize', resizeCanvas);

  updateAdminUI();
</script>
  
</body>
</html>
