<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ Siah To Do</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="todo.css">
  <!-- SortableJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
</head>
<body>
  <canvas id="stars"></canvas>

  <!-- Theme Toggle -->
  <div id="toggle-theme" class="theme-switch">
    <label class="theme-switch">
      <input type="checkbox" id="toggle-theme-checkbox">
      <span class="slider"></span>
    </label>
  </div>

  <div class="container">
    <div class="top-bar">
      <div class="button-group">
        <button id="enter-password">ğŸ” Enter Password</button>
        <button id="logout">ğŸšª Logout</button>
      </div>
      <h1><span>âœ…</span> Siah To Do</h1>
    </div>
  </div>

  <div class="main-content">
    <!-- To Do List Container -->
    <div id="todo-container" class="card-container">
      <h2>To Do List</h2>
      <input type="text" id="todo-input" placeholder="Type a task and hit Enter..." />
      <div class="controls">
        <label><input type="checkbox" id="select-all"> Select All</label>
        <button onclick="deleteSelected()">ğŸ—‘ï¸ Delete Selected</button>
        <button id="undo-btn">â†©ï¸ Undo</button>
      </div>
      <ul id="todo-list"></ul>
    </div>

    <!-- âœ… Done List Container -->
    <div id="done-container" class="card-container">
      <h2>Marked as Done âœ…</h2>
      <ul id="done-list"></ul>
    </div>
  </div>

  <!-- Admin Login Modal -->
  <div id="admin-modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-title">Admin Login</h2>
      <div id="login-form">
        <input type="password" id="password-input" placeholder="Password" />
        <div class="modal-buttons">
          <button id="login-btn">Login</button>
          <button id="cancel-btn">Cancel</button>
        </div>
      </div>
      <div id="logout-form" style="display: none;">
        <p>You are logged in as Admin.</p>
        <div class="modal-buttons">
          <button id="logout-modal-btn">Logout</button>
          <button id="close-modal-btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="back-button-wrapper">
    <a href="https://siahverse.cc/" class="back-button">Back</a>
  </div>

<script>
  const API = '/todos';
  const todoInput = document.getElementById('todo-input');
  const todoList = document.getElementById('todo-list');
  const doneList = document.getElementById('done-list'); // âœ…
  const undoBtn = document.getElementById('undo-btn');
  const selectAll = document.getElementById('select-all');
  const themeCheckbox = document.getElementById('toggle-theme-checkbox');

  const adminModal = document.getElementById('admin-modal');
  const loginBtn = document.getElementById('login-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const passwordInput = document.getElementById('password-input');
  const enterPwBtn = document.getElementById('enter-password');
  const logoutBtn = document.getElementById('logout');
  const logoutModalBtn = document.getElementById('logout-modal-btn');
  const closeModalBtn = document.getElementById('close-modal-btn');

  let deletedTodos = [];
  let todosData = [];
  let doneData = []; // âœ…

  const ADMIN_PASSWORD_KEY = 'adminPassword';
  const getAdminPassword = () => localStorage.getItem(ADMIN_PASSWORD_KEY);

  // Theme toggle
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    document.body.classList.add('light-mode');
    themeCheckbox.checked = true;
  }
  themeCheckbox.addEventListener('change', () => {
    document.body.classList.toggle('light-mode');
    const isLight = document.body.classList.contains('light-mode');
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
  });

  // Admin password helper and events
  const getPassword = () => {
    let pw = localStorage.getItem('adminPassword');
    if (!pw) {
      pw = prompt("Enter admin password:");
      if (pw) localStorage.setItem('adminPassword', pw);
    }
    return pw;
  };

  enterPwBtn.addEventListener('click', () => {
    const pw = prompt("Enter admin password:");
    if (pw) {
      localStorage.setItem('adminPassword', pw);
      fetchTodos();
    }
  });

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('adminPassword');
    alert("Password cleared.");
  });

  // Admin Login/Logout Logic
  cancelBtn.addEventListener('click', () => adminModal.style.display = 'none');
  closeModalBtn.addEventListener('click', () => adminModal.style.display = 'none');

  loginBtn.addEventListener('click', () => {
    const password = passwordInput.value.trim();
    if (password == 'adminPassword') {
      localStorage.setItem(ADMIN_PASSWORD_KEY, password);
      alert("Login successful!");
      todoInput.disabled = false;
      adminModal.style.display = 'none';
    } else {
      alert("Invalid password.");
    }
  });

  logoutModalBtn.addEventListener('click', () => {
    localStorage.removeItem(ADMIN_PASSWORD_KEY);
    alert("Logged out successfully.");
    adminModal.style.display = 'none';
    todoInput.disabled = true;
  });

  if (!getAdminPassword()) {
    todoInput.disabled = true;
  }

  // Fetch and render todos
  const fetchTodos = async () => {
    try {
      const res = await fetch(API);
      const allData = await res.json();
      todosData = allData.todos || [];
      doneData = allData.done || [];

      renderTodos();
      renderDone();
    } catch (err) {
      console.error("Error fetching todos:", err);
    }
  };

  // Render To-Do List
  const renderTodos = () => {
    todoList.innerHTML = '';
    todosData.forEach((todo, index) => {
      const li = document.createElement('li');
      li.setAttribute('data-index', index);
      li.innerHTML = `
        <input type="checkbox" class="select-todo" data-index="${index}" />
        <span>${todo.todo || todo}</span>
        <div>
          <button onclick="markAsDone(${index})">âœ…</button>
          <button onclick="removeTodo(${index}, '${(todo.todo || todo).replace(/'/g, "\\'")}')">âŒ</button>
        </div>
      `;
      todoList.appendChild(li);
    });
  };

  // Render Done List
  const renderDone = () => {
    doneList.innerHTML = '';
    doneData.forEach((task, i) => {
      const li = document.createElement('li');
      li.classList.add('done');
      li.innerHTML = `
        <span>${task}</span>
        <button onclick="removeDone(${i}, '${task.replace(/'/g, "\\'")}')">âŒ</button>
      `;
      doneList.appendChild(li);
    });
  };

  // Mark as Done
  window.markAsDone = async (index) => {
    const task = todosData[index].todo || todosData[index];
    doneData.push(task);
    todosData.splice(index, 1);
    await fetch(API, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ todos: todosData, done: doneData })
    });
    renderTodos();
    renderDone();
  };

  // Remove todo
  const removeTodo = async (index, text) => {
    if (!getAdminPassword()) {
      alert("Only admin can delete tasks.");
      return;
    }
    todosData.splice(index, 1);
    await fetch(API, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ todos: todosData, done: doneData })
    });
    deletedTodos.push(text);
    renderTodos();
  };

  // Remove from Done
  window.removeDone = async (index, text) => {
    if (!getAdminPassword()) {
      alert("Only admin can delete tasks.");
      return;
    }
    doneData.splice(index, 1);
    await fetch(API, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ todos: todosData, done: doneData })
    });
    deletedTodos.push(text);
    renderDone();
  };

  // Undo
  undoBtn.addEventListener('click', async () => {
    for (let todoText of deletedTodos.reverse()) {
      todosData.push({ todo: todoText });
    }
    deletedTodos = [];
    await fetch(API, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ todos: todosData, done: doneData })
    });
    renderTodos();
  });

  // Add todo on Enter
  todoInput.addEventListener('keydown', async (e) => {
    if (e.key === 'Enter' && todoInput.value.trim()) {
      if (!getAdminPassword()) {
        alert("Only admin can add tasks.");
        return;
      }
      todosData.push({ todo: todoInput.value.trim() });
      await fetch(API, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ todos: todosData, done: doneData })
      });
      todoInput.value = '';
      renderTodos();
    }
  });

  // Make the Toâ€‘Do list draggable using SortableJS
  new Sortable(todoList, {
    animation: 150,
    onEnd: async function (evt) {
      // Reorder todosData based on new order of li elements
      const newOrder = [];
      const items = todoList.querySelectorAll('li');
      items.forEach(item => {
        const index = item.getAttribute('data-index');
        newOrder.push(todosData[index]);
      });
      todosData = newOrder;
      // Update backend with new order
      await fetch(API, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ todos: todosData, done: doneData })
      });
      renderTodos(); // Re-render the list with correct indices
    }
  });

  fetchTodos();

  // Star Background Animation
  window.addEventListener("DOMContentLoaded", () => {
    const canvas = document.getElementById("stars");
    const ctx = canvas.getContext("2d");
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      w = canvas.width;
      h = canvas.height;
    }
    let w, h;
    resizeCanvas();
    let stars = Array.from({ length: 500 }, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      r: Math.random() * 1.5 + 0.5,
      d: Math.random() * 0.5 + 0.2
    }));
    function draw() {
      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star-color').trim();
      for (let s of stars) {
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        ctx.fill();
      }
      move();
    }
    function move() {
      for (let s of stars) {
        s.y -= s.d;
        if (s.y < 0) {
          s.y = h;
          s.x = Math.random() * w;
        }
      }
    }
    function animate() {
      draw();
      requestAnimationFrame(animate);
    }
    animate();
    window.addEventListener('resize', resizeCanvas);
  });
</script>
</body>
</html>
