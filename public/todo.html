<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>ğŸ“ Siah To Do</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="todo.css">
    <!-- SortableJS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  </head>
  <body>
    <canvas id="stars"></canvas>

    <!-- Moved theme slider out of container and placed at the upper right -->
    <div id="toggle-theme" class="theme-switch">
      <label class="theme-switch">
        <input type="checkbox" id="toggle-theme-checkbox">
        <span class="slider"></span>
      </label>
    </div>

    <div class="container">
      <div class="top-bar">
        <div class="button-group">
          <!-- Only two admin buttons are kept here -->
          <button id="enter-password">ğŸ” Enter Password</button>
          <button id="logout">ğŸšª Logout</button
        </div>
        <h1><span>âœ…</span> Siah To Do</h1>
      </div>
    </div>

    <div class="main-content">
      <!-- To Do List Container -->
      <div id="todo-container" class="card-container">
        <h2>To Do List</h2>
        <input type="text" id="todo-input" placeholder="Type a task and hit Enter..." />
        <div class="controls">
          <label><input type="checkbox" id="select-all-todo"> Select All</label>
          <button onclick="deleteSelected('todo')">ğŸ—‘ï¸ Delete Selected</button>
          <button id="undo-btn">â†©ï¸ Undo</button>
        </div>
        <ul id="todo-list"></ul>
      </div>

      <!-- Marked As Done List -->
      <div id="done-container" class="card-container">
        <h2>Marked As Done</h2>
        <div class="controls">
          <label><input type="checkbox" id="select-all-done"> Select All</label>
          <button onclick="deleteSelected('done')">ğŸ—‘ï¸ Delete Selected</button>
        </div>
        <ul id="done-list"></ul>
      </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-modal" class="modal">
      <div class="modal-content">
        <h2 id="modal-title">Admin Login</h2>
        <div id="login-form">
          <!-- Username input removed -->
          <input type="password" id="password-input" placeholder="Password" />
          <div class="modal-buttons">
            <button id="login-btn">Login</button>
            <button id="cancel-btn">Cancel</button>
          </div>
        </div>
        <div id="logout-form" style="display: none;">
          <p>You are logged in as Admin.</p>
          <div class="modal-buttons">
            <button id="logout-modal-btn">Logout</button>
            <button id="close-modal-btn">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="back-button-wrapper">
      <a href="https://siahverse.cc/" class="back-button">Back</a>
    </div>

    <script>
      const API = '/todos';
      const todoInput = document.getElementById('todo-input');
      const todoList = document.getElementById('todo-list');
      const doneList = document.getElementById('done-list');
      const themeToggle = document.getElementById('toggle-theme');
      const undoBtn = document.getElementById('undo-btn');
      const selectAllTodo = document.getElementById('select-all-todo');
      const selectAllDone = document.getElementById('select-all-done');

      // Modal elements
      const adminModal = document.getElementById('admin-modal');
      const modalTitle = document.getElementById('modal-title');
      const loginForm = document.getElementById('login-form');
      const logoutForm = document.getElementById('logout-form');
      const passwordInput = document.getElementById('password-input');
      const loginBtn = document.getElementById('login-btn');
      const cancelBtn = document.getElementById('cancel-btn');
      const logoutModalBtn = document.getElementById('logout-modal-btn');
      const closeModalBtn = document.getElementById('close-modal-btn');
      const enterPwBtn = document.getElementById('enter-password');
      const logoutBtn = document.getElementById('logout');

      let deletedTodos = [];
      //let todosData = []; // Stores all todo data (including status)
      
      //theme toggle logic
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        themeToggle.checked = true;
      }
      themeToggle.addEventListener('change', () => {
        document.body.classList.toggle('light-mode');
        const isLight = document.body.classList.contains('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
      });

      // --- Admin Login/Logout Logic ---
      const ADMIN_PASSWORD_KEY = 'adminPassword';
      const getAdminPassword = () => localStorage.getItem(ADMIN_PASSWORD_KEY);

      const showModal = (isLoggedIn) => {
        adminModal.style.display = 'flex';
        if (isLoggedIn) {
          modalTitle.textContent = 'Admin Options';
          loginForm.style.display = 'none';
          logoutForm.style.display = 'block';
        } else {
          modalTitle.textContent = 'Admin Login';
          loginForm.style.display = 'block';
          logoutForm.style.display = 'none';
          passwordInput.value = '';
        }
      };

      const hideModal = () => {
        adminModal.style.display = 'none';
      };

      // When "Enter Password" is clicked, open the modal.
      enterPwBtn.addEventListener('click', () => {
        const pw = prompt("Enter admin password:");
        if (pw) {
          localStorage.setItem('adminPassword', pw);
          fetchTodos(); // Refresh to load data
        }
      });

      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('adminPassword');
        alert("Password cleared.");
      });

      // Admin login event â€“ check only password (example: "password123")
      loginBtn.addEventListener('click', () => {
        const password = passwordInput.value.trim();
        if (password === 'password123') {
          localStorage.setItem(ADMIN_PASSWORD_KEY, password);
          alert("Login successful!");
          hideModal();
          todoInput.disabled = false;
        } else {
          alert("Invalid password.");
        }
      });

      cancelBtn.addEventListener('click', hideModal);
      closeModalBtn.addEventListener('click', hideModal);

      // Logout from modal
      logoutModalBtn.addEventListener('click', () => {
        localStorage.removeItem(ADMIN_PASSWORD_KEY);
        alert("Logged out successfully.");
        hideModal();
        todoInput.disabled = true;
      });

      // "Logout" button (top bar) clears admin password
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem(ADMIN_PASSWORD_KEY);
        alert("Password cleared.");
        todoInput.disabled = true;
      });

      // Initially disable task input if admin isn't logged in.
      if (!getAdminPassword()) {
        todoInput.disabled = true;
      }
      // --- End Admin Login/Logout Logic ---

      undoBtn.addEventListener('click', async () => {
        for (let todoText of deletedTodos.reverse()) {
          await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ todo: todoText, done: false })
          });
        }
        deletedTodos = [];
        fetchTodos();
      });

      // Fetch and render all todos
      const fetchTodos = async () => {
        const res = await fetch(API);
        const todos = await res.json();
        todoList.innerHTML = '';
        todos.forEach((todo, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <input type="checkbox" class="select-todo" data-index="${index}" />
            <span>${todo}</span>
            <button onclick="removeTodo(${index}, '${todo.replace(/'/g, "\\'")}')">âŒ</button>
          `;
          todoList.appendChild(li);
        });
      };

      // Remove a specific todo item based on its index
      const removeTodo = async (index, text) => {
        const res = await fetch(`${API}/${index}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${getPassword()}`,
          },
        });
        if (res.ok) {
          if (text) deletedTodos.push(text);
          fetchTodos();
        } else {
          alert("âŒ Failed to delete (wrong password?)");
        }
      };

      // Deletes todos that have been selected via checkbox
      const deleteSelected = async () => {
        const checkboxes = document.querySelectorAll('.select-todo:checked');
        const indices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
        // Delete items from highest index to lowest so that the remaining indices won't be shifted.
        indices.sort((a, b) => b - a);
        for (let i of indices) {
          const span = todoList.querySelector(`.select-todo[data-index="${i}"]`).nextElementSibling;
          deletedTodos.push(span.textContent);
          await removeTodo(i);
        }
      };

      // "Select All" functionality
      document.getElementById('select-all').addEventListener('change', (e) => {
        document.querySelectorAll('.select-todo').forEach(cb => cb.checked = e.target.checked);
      });

      // Add new todo when pressing "Enter" in the todo input field
      todoInput.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && todoInput.value.trim()) {
          await fetch(API, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ todo: todoInput.value.trim() })
          });
          todoInput.value = '';
          fetchTodos();
        }
      });

      new Sortable(todoList, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: async function (evt) {
          console.log(`Moved "${evt.item.querySelector('span').textContent}" from index ${evt.oldIndex} to ${evt.newIndex} within the To Do list.`);
          alert("Drag and drop reordering is client-side only in this demo. A backend update would be needed for persistence.");
          fetchTodos();
        }
      });

      fetchTodos();

      // Star background code
      window.addEventListener("DOMContentLoaded", () => {
        const canvas = document.getElementById("stars");
        const ctx = canvas.getContext("2d");

        function resizeCanvas() {
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          w = canvas.width;
          h = canvas.height;
        }

        let w, h;
        resizeCanvas();

        let stars = Array.from({ length: 500 }, () => ({
          x: Math.random() * w,
          y: Math.random() * h,
          r: Math.random() * 1.5 + 0.5,
          d: Math.random() * 0.5 + 0.2
        }));

        function draw() {
          ctx.clearRect(0, 0, w, h);
          ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--star-color').trim();
          for (let s of stars) {
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
            ctx.fill();
          }
          move();
        }

        function move() {
          for (let s of stars) {
            s.y -= s.d;
            if (s.y < 0) {
              s.y = h;
              s.x = Math.random() * w;
            }
          }
        }

        function animate() {
          draw();
          requestAnimationFrame(animate);
        }

        animate();
        document.body.classList.add("fade-in");

        window.addEventListener('resize', () => {
          resizeCanvas();
          stars = Array.from({ length: 150 }, () => ({
            x: Math.random() * w,
            y: Math.random() * h,
            r: Math.random() * 1.5 + 0.5,
            d: Math.random() * 0.5 + 0.2
          }));
        });
      });
      // --- End Star Background Code ---
    </script>
  </body>
</html>
